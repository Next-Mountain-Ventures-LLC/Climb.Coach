---
import BaseLayout from '@/layouts/BaseLayout.astro';
import SocialShare from '@/components/blog/SocialShare';
import Newsletter from '@/components/sections/Newsletter';
import { getAllCategories, getCategoriesForPost, formatDate, getAuthorById } from '@/lib/blog';
import type { WordPressPost, WordPressCategory, WordPressAuthor } from '@/lib/blog';
import { CalendarDays, User } from 'lucide-react';

interface Props {
  post: WordPressPost;
  relatedPosts?: WordPressPost[];
}

const { post, relatedPosts = [] } = Astro.props;

// Format the date
const formattedDate = formatDate(post.date);

// Get categories for this post
const postCategories = await getCategoriesForPost(post.categories);

// Get all categories for the sidebar
const allCategories = await getAllCategories();

// Get author information
const author = await getAuthorById(post.author);

// Construct the canonical URL
const canonicalUrl = new URL(Astro.url.pathname, Astro.site);

// We now use a shared SEO component
---

<BaseLayout
>
  <main class="pt-8 pb-16">
    <div class="container px-4 sm:px-6 lg:px-8 mx-auto">
      <div class="max-w-4xl mx-auto">
        <!-- Post Header -->
        <header class="mb-8">
          <h1 class="text-3xl md:text-4xl lg:text-5xl font-heading font-bold text-charcoal mb-4">
            {post.title.rendered}
          </h1>

          <div class="flex flex-wrap items-center gap-4 text-dark-slate/70 mb-6">
            <div class="flex items-center gap-2">
              <CalendarDays className="h-4 w-4" />
              <span>{formattedDate}</span>
            </div>
            {author && (
              <div class="flex items-center gap-2">
                <User className="h-4 w-4" />
                <span>By {author.name}</span>
              </div>
            )}
          </div>
        </header>

        {post.jetpack_featured_media_url && (
          <div class="mb-8 rounded-xl overflow-hidden shadow-md">
            <img
              src={post.jetpack_featured_media_url}
              alt={post.title.rendered}
              class="w-full max-h-[500px] object-cover"
            />
          </div>
        )}

        <!-- Post Content -->
        <article class="prose prose-lg max-w-none mb-10">
          <!-- Apply styles directly to enhance WordPress content with higher specificity -->
          <style is:inline>
            /* Direct styling for WordPress headings to ensure they render properly with high specificity */
            article.prose h2.wp-block-heading {
              font-family: var(--font-heading) !important;
              font-weight: 700 !important;
              font-size: clamp(1.5rem, 3vw, 2rem) !important;
              color: #364958 !important;
              margin-top: 2rem !important;
              margin-bottom: 1rem !important;
              line-height: 1.2 !important;
            }
            
            article.prose h3.wp-block-heading {
              font-family: var(--font-heading) !important;
              font-weight: 700 !important;
              font-size: clamp(1.25rem, 2.5vw, 1.75rem) !important;
              color: #364958 !important;
              margin-top: 1.75rem !important;
              margin-bottom: 0.75rem !important;
              line-height: 1.2 !important;
            }
            
            article.prose h4.wp-block-heading {
              font-family: var(--font-heading) !important;
              font-weight: 700 !important;
              font-size: clamp(1.125rem, 2vw, 1.5rem) !important;
              color: #364958 !important;
              margin-top: 1.5rem !important;
              margin-bottom: 0.75rem !important;
              line-height: 1.2 !important;
            }
            
            article.prose ul.wp-block-list {
              margin-top: 1.25rem !important;
              margin-bottom: 1.25rem !important;
              padding-left: 1.75rem !important;
              list-style-type: disc !important;
            }
            
            article.prose p {
              color: #3B6064 !important;
              line-height: 1.75 !important;
              margin-top: 1.25rem !important;
              margin-bottom: 1.25rem !important;
              font-size: clamp(1rem, 1.5vw, 1.125rem) !important;
            }
            
            /* Standard heading elements without wp-block-heading class, for fallback */
            article.prose h1, 
            article.prose h2, 
            article.prose h3, 
            article.prose h4 {
              font-family: var(--font-heading) !important;
              font-weight: 700 !important;
              color: #364958 !important;
              line-height: 1.2 !important;
            }
            
            article.prose h1 {
              font-size: clamp(1.875rem, 4vw, 2.5rem) !important;
              margin-top: 2rem !important;
              margin-bottom: 1rem !important;
            }
            
            article.prose h2 {
              font-size: clamp(1.5rem, 3vw, 2rem) !important;
              margin-top: 2rem !important;
              margin-bottom: 1rem !important;
            }
            
            article.prose h3 {
              font-size: clamp(1.25rem, 2.5vw, 1.75rem) !important;
              margin-top: 1.75rem !important;
              margin-bottom: 0.75rem !important;
            }
            
            article.prose h4 {
              font-size: clamp(1.125rem, 2vw, 1.5rem) !important;
              margin-top: 1.5rem !important;
              margin-bottom: 0.75rem !important;
            }
          </style>
          <div set:html={post.content.rendered} />
        </article>

        <!-- Social Share and Author Bio -->
        <div class="border-t border-b border-gray-200 py-6 my-8">
          <div class="mb-6">
            <SocialShare url={canonicalUrl.toString()} title={post.title.rendered} client:load />
          </div>
          
          {author && (
            <div class="flex items-start gap-4 pt-4 border-t border-gray-100">
              {author.avatar_urls && author.avatar_urls['96'] && (
                <img 
                  src={author.avatar_urls['96']} 
                  alt={author.name} 
                  class="w-16 h-16 rounded-full object-cover"
                />
              )}
              <div>
                <h3 class="text-lg font-heading font-bold text-charcoal mb-1">About {author.name}</h3>
                <p class="text-dark-slate/90 text-sm">
                  {author.description || `${author.name} is a contributor at Climb.Coach.`}
                </p>
              </div>
            </div>
          )}
        </div>

        <!-- Related Posts -->
        {relatedPosts.length > 0 && (
          <div class="mt-12">
            <h2 class="text-2xl font-heading font-bold text-charcoal mb-6">Related Articles</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {relatedPosts.map(relatedPost => (
                <div class="bg-white rounded-lg overflow-hidden border border-mountain-green/20 shadow-sm hover:shadow-md transition-all duration-300">
                  {relatedPost.jetpack_featured_media_url && (
                    <a href={`/blog/${relatedPost.slug}`} class="block">
                      <img 
                        src={relatedPost.jetpack_featured_media_url}
                        alt={relatedPost.title.rendered}
                        class="w-full h-40 object-cover"
                      />
                    </a>
                  )}
                  <div class="p-4">
                    <h3 class="text-lg font-heading font-bold text-charcoal mb-2 hover:text-blue-mell transition-colors">
                      <a href={`/blog/${relatedPost.slug}`}>{relatedPost.title.rendered}</a>
                    </h3>
                    <div class="flex items-center gap-1 text-xs text-dark-slate/70 mb-2">
                      <CalendarDays className="h-3 w-3" />
                      <span>{formatDate(relatedPost.date)}</span>
                    </div>
                    <a 
                      href={`/blog/${relatedPost.slug}`}
                      class="inline-flex items-center text-sm font-medium text-blue-mell hover:text-dark-slate transition-colors"
                    >
                      Read More
                      <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M14 5l7 7m0 0l-7 7m7-7H3" />
                      </svg>
                    </a>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  </main>
  
  <Newsletter />
</BaseLayout>