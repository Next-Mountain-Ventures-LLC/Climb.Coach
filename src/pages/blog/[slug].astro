---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getClimbCoachPosts, getPostBySlug, formatWordPressDate, getPostCategories, getFeaturedImageUrl } from '../../lib/wordpress-api';
import { ChevronLeft } from 'lucide-react';
import BlogCarousel from '../../components/blog/BlogCarousel';

// Generate static pages for each blog post at build time
export async function getStaticPaths() {
  const posts = await getClimbCoachPosts(100); // Get up to 100 posts to generate static pages
  
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

// Get the post data
const { slug } = Astro.params;
const { post } = Astro.props;

// Format data
const formattedDate = formatWordPressDate(post.date);
const categories = getPostCategories(post);
const featuredImage = getFeaturedImageUrl(post, 'large');

// Define metadata for the page
const title = post.title.rendered + " | Climb.Coach Blog";

// Create a description from the excerpt
const excerpt = post.excerpt.rendered
  .replace(/<[^>]*>/g, '')  // Remove HTML tags
  .replace(/&nbsp;/g, ' ')  // Replace &nbsp; with space
  .replace(/\n/g, ' ')      // Replace newlines with spaces
  .trim();

const description = excerpt.length > 160
  ? excerpt.substring(0, 157) + '...'
  : excerpt;
---

<BaseLayout title={title} description={description} image={featuredImage}>
  <article class="py-12 lg:py-16">
    <div class="container mx-auto px-4">
      <!-- Back to blog link -->
      <div class="mb-8">
        <a href="/blog" class="inline-flex items-center text-mountain-green hover:text-blue-mell transition-colors font-medium">
          <ChevronLeft className="h-4 w-4 mr-1" />
          Back to all articles
        </a>
      </div>

      <!-- Post header -->
      <header class="max-w-3xl mx-auto mb-10">
        <div class="mb-4 flex flex-wrap gap-2">
          {categories.map(category => (
            <span 
              class="inline-flex items-center rounded-full bg-cambridge-blue/10 px-3 py-1 text-sm font-medium text-cambridge-blue"
            >
              {category.name}
            </span>
          ))}
        </div>

        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-charcoal mb-4" set:html={post.title.rendered} />
        
        <div class="mt-4 mb-6">
          <p class="text-dark-slate/60">
            Published on {formattedDate}
          </p>
        </div>

        <!-- Featured Image -->
        {featuredImage && (
          <div class="relative h-64 sm:h-80 md:h-96 mb-10 overflow-hidden rounded-lg">
            <img 
              src={featuredImage}
              alt={post.title.rendered}
              class="w-full h-full object-cover"
            />
          </div>
        )}
      </header>

      <!-- Post content -->
      <div class="max-w-3xl mx-auto">
        <div 
          class="prose prose-lg max-w-none prose-headings:text-charcoal prose-headings:font-bold prose-p:text-dark-slate prose-a:text-blue-mell prose-a:no-underline hover:prose-a:underline prose-strong:text-charcoal prose-ul:text-dark-slate prose-ol:text-dark-slate prose-li:marker:text-mountain-green"
          set:html={post.content.rendered}
        />
      </div>

      <!-- Author/Share section -->
      <div class="max-w-3xl mx-auto mt-12 pt-8 border-t border-cambridge-blue/20">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
          <div>
            <a href="/blog" class="text-mountain-green hover:text-blue-mell transition-colors font-medium">
              Read more articles
            </a>
          </div>
          
          <!-- Social share buttons would go here -->
        </div>
      </div>
    </div>
  </article>

  <!-- Related articles -->
  <section class="py-12 bg-cambridge-blue/5">
    <div class="container mx-auto px-4">
      <h2 class="text-2xl font-bold text-charcoal mb-8">You Might Also Like</h2>
      <BlogCarousel client:load />
    </div>
  </section>
</BaseLayout>
---