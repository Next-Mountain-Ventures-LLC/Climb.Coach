---
import BlogPostLayout from '@/layouts/BlogPostLayout.astro';
import { getClimbCoachPosts, getPostBySlug } from '@/lib/blog';
import type { GetStaticPathsResult } from 'astro';

// Define the params type
interface Props {
  post: any;
  relatedPosts: any[];
}

// Get static paths for all posts
export async function getStaticPaths(): Promise<GetStaticPathsResult> {
  console.log("Starting getStaticPaths for blog posts at: ", new Date().toISOString());
  
  // Get all posts
  const { posts } = await getClimbCoachPosts(1);
  
  console.log(`Found ${posts.length} posts on first page. Titles: ${posts.map(p => p.title.rendered).join(', ')}`);
  
  // Determine the total pages
  const totalPages = Math.ceil(posts.length / 10);
  console.log(`Total pages determined: ${totalPages}`);
  
  // Fetch all posts across all pages
  const allPosts = [];
  
  // First page is already fetched
  allPosts.push(...posts);
  
  // Fetch remaining pages
  for (let i = 2; i <= totalPages; i++) {
    console.log(`Fetching page ${i} of ${totalPages}`);
    const { posts: pagePosts } = await getClimbCoachPosts(i);
    console.log(`Found ${pagePosts.length} posts on page ${i}`);
    allPosts.push(...pagePosts);
  }
  
  console.log(`Total posts to generate: ${allPosts.length}. Slugs: ${allPosts.map(p => p.slug).join(', ')}`);
  
  // Double-check for "does-this-work" slug
  const doesThisWorkPost = allPosts.find(p => p.slug === "does-this-work");
  if (doesThisWorkPost) {
    console.warn("WARNING: The 'does-this-work' post is still present despite being deleted from WordPress!");
  }
  
  // Generate static paths
  return allPosts.map(post => {
    // Get related posts (excluding current post)
    const relatedPosts = allPosts
      .filter(p => p.id !== post.id)
      // Only include posts with at least one matching category
      .filter(p => p.categories.some(cat => post.categories.includes(cat)))
      // Sort by date (newest first)
      .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
      // Limit to 3 related posts
      .slice(0, 3);
    
    return {
      params: { slug: post.slug },
      props: { post, relatedPosts }
    };
  });
}

// Get props from getStaticPaths
const { post, relatedPosts } = Astro.props;

// If post wasn't found in getStaticPaths (unlikely), redirect to blog index
if (!post) {
  return Astro.redirect('/blog');
}
---

<BlogPostLayout post={post} relatedPosts={relatedPosts} />
---